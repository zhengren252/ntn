# Alertmanager é…ç½®æ–‡ä»¶
# ç”¨äºä¿¡æ¯æºçˆ¬è™«æ¨¡ç»„çš„å‘Šè­¦ç®¡ç†

global:
  # SMTPé…ç½®
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@neurotrade-nexus.com'
  smtp_auth_username: '${SMTP_USERNAME}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true
  
  # é»˜è®¤æ¥æ”¶è€…
  smtp_hello: 'alertmanager'
  
  # è§£æè¶…æ—¶
  resolve_timeout: 5m
  
  # HTTPé…ç½®
  http_config:
    tls_config:
      insecure_skip_verify: false

# æ¨¡æ¿é…ç½®
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# è·¯ç”±é…ç½®
route:
  # é»˜è®¤æ¥æ”¶è€…
  receiver: 'default-receiver'
  
  # åˆ†ç»„é…ç½®
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  
  # å­è·¯ç”±
  routes:
    # ç³»ç»Ÿçº§ä¸¥é‡å‘Šè­¦
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      group_interval: 5s
      repeat_interval: 30m
      continue: true
    
    # åº”ç”¨æœåŠ¡å‘Šè­¦
    - match:
        service: info-crawler
      receiver: 'app-alerts'
      group_by: ['alertname', 'instance']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 2h
    
    # Rediså‘Šè­¦
    - match:
        service: redis
      receiver: 'redis-alerts'
      group_by: ['alertname', 'instance']
      group_wait: 30s
      group_interval: 10m
      repeat_interval: 4h
    
    # çˆ¬è™«ä»»åŠ¡å‘Šè­¦
    - match:
        service: crawler
      receiver: 'crawler-alerts'
      group_by: ['alertname', 'source']
      group_wait: 1m
      group_interval: 15m
      repeat_interval: 6h
    
    # ZeroMQå‘Šè­¦
    - match:
        service: zmq
      receiver: 'zmq-alerts'
      group_by: ['alertname']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 2h
    
    # Telegramå‘Šè­¦
    - match:
        service: telegram
      receiver: 'telegram-alerts'
      group_by: ['alertname']
      group_wait: 1m
      group_interval: 10m
      repeat_interval: 4h
    
    # æ•°æ®è´¨é‡å‘Šè­¦
    - match:
        service: data-quality
      receiver: 'data-quality-alerts'
      group_by: ['alertname']
      group_wait: 2m
      group_interval: 30m
      repeat_interval: 12h
    
    # ç½‘ç»œå’ŒSSLå‘Šè­¦
    - match_re:
        service: network|ssl
      receiver: 'network-alerts'
      group_by: ['alertname', 'instance']
      group_wait: 1m
      group_interval: 15m
      repeat_interval: 8h
    
    # å®¹å™¨å‘Šè­¦
    - match:
        service: container
      receiver: 'container-alerts'
      group_by: ['alertname', 'container']
      group_wait: 30s
      group_interval: 10m
      repeat_interval: 4h

# æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # æœåŠ¡ä¸‹çº¿æ—¶æŠ‘åˆ¶å…¶ä»–å‘Šè­¦
  - source_match:
      alertname: ServiceDown
    target_match_re:
      alertname: HighAPIResponseTime|HighAPIErrorRate
    equal: ['instance']
  
  # Redisä¸‹çº¿æ—¶æŠ‘åˆ¶ç›¸å…³å‘Šè­¦
  - source_match:
      alertname: RedisDown
    target_match_re:
      alertname: RedisHighMemoryUsage|RedisHighConnections
    equal: ['instance']
  
  # ç³»ç»Ÿèµ„æºå‘Šè­¦æŠ‘åˆ¶
  - source_match:
      alertname: HighCPUUsage
    target_match:
      alertname: HighMemoryUsage
    equal: ['instance']

# æ¥æ”¶è€…é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶è€…
  - name: 'default-receiver'
    email_configs:
      - to: 'admin@neurotrade-nexus.com'
        subject: '[NTN-çˆ¬è™«æ¨¡ç»„] {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          æœåŠ¡åç§°: {{ .Labels.service }}
          å®ä¾‹åœ°å€: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .EndsAt }}ç»“æŸæ—¶é—´: {{ .EndsAt.Format "2006-01-02 15:04:05" }}{{ end }}
          
          æ ‡ç­¾ä¿¡æ¯:
          {{ range .Labels.SortedPairs }}- {{ .Name }}: {{ .Value }}
          {{ end }}
          {{ end }}
        headers:
          Subject: '[NTN-çˆ¬è™«æ¨¡ç»„] {{ .GroupLabels.alertname }}'
  
  # ä¸¥é‡å‘Šè­¦æ¥æ”¶è€…
  - name: 'critical-alerts'
    email_configs:
      - to: 'admin@neurotrade-nexus.com,ops@neurotrade-nexus.com'
        subject: '[ç´§æ€¥å‘Šè­¦] {{ .GroupLabels.alertname }}'
        body: |
          ğŸš¨ ç´§æ€¥å‘Šè­¦é€šçŸ¥ ğŸš¨
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          æœåŠ¡åç§°: {{ .Labels.service }}
          å®ä¾‹åœ°å€: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          è¯·ç«‹å³å¤„ç†æ­¤å‘Šè­¦ï¼
          {{ end }}
        headers:
          Priority: 'high'
    # å¯é€‰ï¼šæ·»åŠ çŸ­ä¿¡é€šçŸ¥
    # webhook_configs:
    #   - url: 'http://sms-gateway:8080/send'
    #     send_resolved: true
  
  # åº”ç”¨æœåŠ¡å‘Šè­¦
  - name: 'app-alerts'
    email_configs:
      - to: 'dev@neurotrade-nexus.com'
        subject: '[åº”ç”¨å‘Šè­¦] {{ .GroupLabels.alertname }}'
        body: |
          åº”ç”¨æœåŠ¡å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          æœåŠ¡åç§°: {{ .Labels.service }}
          å®ä¾‹åœ°å€: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          ç›‘æ§é¢æ¿: http://grafana:3000/d/info-crawler
          æ—¥å¿—æŸ¥çœ‹: http://grafana:3000/explore
          {{ end }}
  
  # Rediså‘Šè­¦
  - name: 'redis-alerts'
    email_configs:
      - to: 'dba@neurotrade-nexus.com'
        subject: '[Rediså‘Šè­¦] {{ .GroupLabels.alertname }}'
        body: |
          RedisæœåŠ¡å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å®ä¾‹åœ°å€: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          Redisç›‘æ§: http://grafana:3000/d/redis-dashboard
          {{ end }}
  
  # çˆ¬è™«ä»»åŠ¡å‘Šè­¦
  - name: 'crawler-alerts'
    email_configs:
      - to: 'crawler-team@neurotrade-nexus.com'
        subject: '[çˆ¬è™«å‘Šè­¦] {{ .GroupLabels.alertname }}'
        body: |
          çˆ¬è™«ä»»åŠ¡å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          æ•°æ®æº: {{ .Labels.source }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          çˆ¬è™«ç›‘æ§: http://grafana:3000/d/crawler-dashboard
          ä»»åŠ¡ç®¡ç†: http://localhost:3000/crawler/tasks
          {{ end }}
  
  # ZeroMQå‘Šè­¦
  - name: 'zmq-alerts'
    email_configs:
      - to: 'dev@neurotrade-nexus.com'
        subject: '[ZeroMQå‘Šè­¦] {{ .GroupLabels.alertname }}'
        body: |
          ZeroMQæ¶ˆæ¯é˜Ÿåˆ—å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          æ¶ˆæ¯é˜Ÿåˆ—ç›‘æ§: http://grafana:3000/d/zmq-dashboard
          {{ end }}
  
  # Telegramå‘Šè­¦
  - name: 'telegram-alerts'
    email_configs:
      - to: 'telegram-team@neurotrade-nexus.com'
        subject: '[Telegramå‘Šè­¦] {{ .GroupLabels.alertname }}'
        body: |
          Telegramç›‘å¬å™¨å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          Telegramç›‘æ§: http://grafana:3000/d/telegram-dashboard
          è¿æ¥ç®¡ç†: http://localhost:3000/telegram/status
          {{ end }}
  
  # æ•°æ®è´¨é‡å‘Šè­¦
  - name: 'data-quality-alerts'
    email_configs:
      - to: 'data-team@neurotrade-nexus.com'
        subject: '[æ•°æ®è´¨é‡å‘Šè­¦] {{ .GroupLabels.alertname }}'
        body: |
          æ•°æ®è´¨é‡å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          æ•°æ®è´¨é‡ç›‘æ§: http://grafana:3000/d/data-quality-dashboard
          æ•°æ®éªŒè¯æŠ¥å‘Š: http://localhost:3000/data/quality
          {{ end }}
  
  # ç½‘ç»œå‘Šè­¦
  - name: 'network-alerts'
    email_configs:
      - to: 'network@neurotrade-nexus.com'
        subject: '[ç½‘ç»œå‘Šè­¦] {{ .GroupLabels.alertname }}'
        body: |
          ç½‘ç»œæœåŠ¡å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          ç›®æ ‡åœ°å€: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          ç½‘ç»œç›‘æ§: http://grafana:3000/d/network-dashboard
          {{ end }}
  
  # å®¹å™¨å‘Šè­¦
  - name: 'container-alerts'
    email_configs:
      - to: 'ops@neurotrade-nexus.com'
        subject: '[å®¹å™¨å‘Šè­¦] {{ .GroupLabels.alertname }}'
        body: |
          Dockerå®¹å™¨å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å®¹å™¨åç§°: {{ .Labels.container }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          å®¹å™¨ç›‘æ§: http://grafana:3000/d/container-dashboard
          DockerçŠ¶æ€: docker ps -a
          {{ end }}

# æ—¶é—´çª—å£é…ç½®
time_intervals:
  - name: 'business-hours'
    time_intervals:
      - times:
          - start_time: '09:00'
            end_time: '18:00'
        weekdays: ['monday:friday']
        location: 'Asia/Shanghai'
  
  - name: 'off-hours'
    time_intervals:
      - times:
          - start_time: '18:01'
            end_time: '08:59'
        weekdays: ['monday:friday']
        location: 'Asia/Shanghai'
      - weekdays: ['saturday', 'sunday']
        location: 'Asia/Shanghai'

# é™é»˜è§„åˆ™ï¼ˆå¯é€‰ï¼‰
# silences:
#   - matchers:
#       - name: alertname
#         value: MaintenanceMode
#     starts_at: '2024-01-01T00:00:00Z'
#     ends_at: '2024-01-01T06:00:00Z'
#     created_by: 'admin@neurotrade-nexus.com'
#     comment: 'ç³»ç»Ÿç»´æŠ¤çª—å£'