{% extends "base.html" %}

{% block title %}ScanPulse 仪表板{% endblock %}

{% block page_title %}仪表板概览{% endblock %}

{% block content %}
<div class="row">
    <!-- 系统状态卡片 -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div class="text-xs font-weight-bold text-uppercase">引擎状态</div>
                            <span class="connection-status connected">已连接</span>
                        </div>
                        <div class="h5 mb-0 font-weight-bold" id="engine-status">运行中</div>
                        <div class="small text-muted">
                            <div>Redis: <span id="redis-status" class="badge bg-success">已连接</span></div>
                            <div>ZMQ: <span id="zmq-status" class="badge bg-success">已连接</span></div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-server fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 活跃交易对 -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">活跃交易对</div>
                        <div class="h5 mb-0 font-weight-bold" id="active-pairs">-</div>
                        <div class="small text-muted">实时监控中</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-coins fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 扫描次数 -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">总扫描次数</div>
                        <div class="h5 mb-0 font-weight-bold" id="total-scans">-</div>
                        <div class="small text-muted">累计扫描</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-search fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 成功率 -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">成功率</div>
                        <div class="h5 mb-0 font-weight-bold" id="success-rate">-</div>
                        <div class="small text-muted">扫描成功率</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 扫描引擎状态 -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold"><i class="fas fa-cogs"></i> 扫描引擎状态</h6>
            </div>
            <div class="card-body">
                <div id="engines-status">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 性能指标 -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold"><i class="fas fa-chart-bar"></i> 实时性能监控</h6>
                <small class="text-muted">最后更新: <span id="last-update">--:--:--</span></small>
            </div>
            <div class="card-body">
                <canvas id="performance-chart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold">系统指标</h6>
            </div>
            <div class="card-body">
                <div class="metric-item mb-3">
                    <div class="d-flex justify-content-between">
                        <span>CPU使用率</span>
                        <span id="cpu-usage" class="fw-bold">0%</span>
                    </div>
                </div>
                <div class="metric-item mb-3">
                    <div class="d-flex justify-content-between">
                        <span>内存使用率</span>
                        <span id="memory-usage" class="fw-bold">0%</span>
                    </div>
                </div>
                <div class="metric-item mb-3">
                    <div class="d-flex justify-content-between">
                        <span>网络延迟</span>
                        <span id="network-latency" class="fw-bold">0ms</span>
                    </div>
                </div>
                <div class="metric-item mb-3">
                    <div class="d-flex justify-content-between">
                        <span>扫描速度</span>
                        <span id="scan-speed" class="fw-bold">0/s</span>
                    </div>
                </div>
                <div class="metric-item">
                    <div class="d-flex justify-content-between">
                        <span>队列大小</span>
                        <span id="queue-size" class="fw-bold">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 最近扫描结果 -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold"><i class="fas fa-list"></i> 最近扫描结果</h6>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="refreshResults()">刷新</button>
                    <a href="/results" class="btn btn-sm btn-primary">查看全部</a>
                </div>
            </div>
            <div class="card-body">
                <div id="recent-results">
                    <div class="text-center text-muted py-4">正在加载...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 系统信息 -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold"><i class="fas fa-info-circle"></i> 系统信息</h6>
            </div>
            <div class="card-body">
                <div id="system-info">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}

.status-running {
    background-color: #28a745;
    animation: pulse 2s infinite;
}

.status-stopped {
    background-color: #dc3545;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.metric-card {
    transition: transform 0.2s;
}

.metric-card:hover {
    transform: translateY(-2px);
}

.chart-container {
    position: relative;
    height: 300px;
}

/* 连接状态样式 */
.connection-status {
    font-size: 0.75rem;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 500;
}

.connection-status.connected {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.connection-status.disconnected {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.5; }
}

/* 指标更新动画 */
.metric-updated {
    animation: highlight 0.5s ease-in-out;
}

@keyframes highlight {
    0% { background-color: transparent; }
    50% { background-color: #fff3cd; }
    100% { background-color: transparent; }
}

/* 结果项样式 */
.result-item {
    transition: all 0.2s ease;
    border: 1px solid #e3e6f0 !important;
}

.result-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-color: #5a5c69 !important;
}

/* 告警容器样式 */
#alert-container {
    max-width: 400px;
}

#alert-container .alert {
    margin-bottom: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* 系统指标样式 */
.metric-item {
    padding: 8px 0;
    border-bottom: 1px solid #e3e6f0;
}

.metric-item:last-child {
    border-bottom: none;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .card-header .btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    .result-item {
        margin-bottom: 0.5rem !important;
    }
    
    .metric-item {
        font-size: 0.9rem;
    }
}

/* 加载状态 */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
let performanceChart, resultsChart, alertsChart;
let lastUpdateTime = Date.now();
let socket;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    initializeWebSocket();
    loadDashboardData();
    
    // 设置定时刷新（作为WebSocket的备用）
    setInterval(loadDashboardData, 60000); // 60秒刷新一次
});

// 初始化WebSocket连接
function initializeWebSocket() {
    socket = io();
    
    socket.on('connect', function() {
        console.log('WebSocket connected');
        reconnectAttempts = 0;
        updateConnectionStatus(true);
    });
    
    socket.on('disconnect', function() {
        console.log('WebSocket disconnected');
        updateConnectionStatus(false);
        attemptReconnect();
    });
    
    socket.on('status_update', function(data) {
        updateSystemStatus(data);
    });
    
    socket.on('metrics_update', function(data) {
        updatePerformanceMetrics(data);
    });
    
    socket.on('results_update', function(data) {
        updateRecentResults(data);
    });
    
    socket.on('new_alert', function(alert) {
        showAlert(alert);
    });
}

// 尝试重连WebSocket
function attemptReconnect() {
    if (reconnectAttempts < maxReconnectAttempts) {
        reconnectAttempts++;
        console.log(`Attempting to reconnect... (${reconnectAttempts}/${maxReconnectAttempts})`);
        setTimeout(() => {
            socket.connect();
        }, 2000 * reconnectAttempts);
    }
}

// 更新连接状态
function updateConnectionStatus(connected) {
    const statusElement = document.querySelector('.connection-status');
    if (statusElement) {
        statusElement.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
        statusElement.textContent = connected ? '已连接' : '连接断开';
    }
}

// 显示告警
function showAlert(alert) {
    const alertContainer = document.getElementById('alert-container');
    if (!alertContainer) {
        // 创建告警容器
        const container = document.createElement('div');
        container.id = 'alert-container';
        container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
        document.body.appendChild(container);
    }
    
    const alertElement = document.createElement('div');
    alertElement.className = `alert alert-${getAlertClass(alert.type)} alert-dismissible fade show`;
    alertElement.innerHTML = `
        <strong>${alert.title}</strong> ${alert.message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.getElementById('alert-container').appendChild(alertElement);
    
    // 5秒后自动消失
    setTimeout(() => {
        if (alertElement.parentNode) {
            alertElement.remove();
        }
    }, 5000);
}

// 获取告警样式类
function getAlertClass(type) {
    const typeMap = {
        'error': 'danger',
        'warning': 'warning',
        'info': 'info',
        'success': 'success'
    };
    return typeMap[type] || 'info';
}

// 初始化图表
function initializeCharts() {
    // 性能指标图表
    const performanceCtx = document.getElementById('performance-chart').getContext('2d');
    performanceChart = new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'CPU使用率',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }, {
                label: '内存使用率',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.1
            }, {
                label: '网络延迟',
                data: [],
                borderColor: 'rgb(255, 205, 86)',
                backgroundColor: 'rgba(255, 205, 86, 0.2)',
                tension: 0.1,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: '使用率 (%)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '延迟 (ms)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
}

// 加载仪表板数据
function loadDashboardData() {
    Promise.all([
        fetch('/api/status').then(r => r.json()),
        fetch('/api/metrics').then(r => r.json()),
        fetch('/api/results?limit=5').then(r => r.json())
    ]).then(([status, metrics, results]) => {
        updateSystemStatus(status);
        updateMetrics(metrics);
        updateRecentResults(results);
        updateEnginesStatus(status.engines);
        updateSystemInfo(status);
    }).catch(error => {
        console.error('Error loading dashboard data:', error);
        showError('system-status', '数据加载失败');
    });
}

// 更新系统状态
function updateSystemStatus(data) {
    // 基础状态信息
    if (data.engine_status !== undefined) {
        document.getElementById('engine-status').textContent = data.engine_status;
        
        // 更新状态指示器
        const statusIndicator = document.querySelector('.status-indicator');
        if (statusIndicator) {
            statusIndicator.className = `status-indicator ${data.engine_status === 'running' ? 'status-running' : 'status-stopped'}`;
        }
    }
    
    if (data.active_pairs !== undefined) {
        document.getElementById('active-pairs').textContent = formatNumber(data.active_pairs);
    }
    
    if (data.total_scans !== undefined) {
        document.getElementById('total-scans').textContent = formatNumber(data.total_scans);
    }
    
    if (data.success_rate !== undefined) {
        document.getElementById('success-rate').textContent = data.success_rate.toFixed(1) + '%';
    }
    
    // 更新连接状态
    if (data.connections) {
        updateConnectionsStatus(data.connections);
    }
    
    // 更新最后更新时间
    lastUpdateTime = Date.now();
    const lastUpdateElement = document.getElementById('last-update');
    if (lastUpdateElement) {
        lastUpdateElement.textContent = formatTime(new Date());
    }
    
    // 兼容原有的系统状态更新
    if (data.scanner) {
        const systemStatusEl = document.getElementById('system-status');
        if (systemStatusEl) {
            systemStatusEl.textContent = data.scanner.status === 'running' ? '运行中' : '离线';
        }
        
        const activeSymbolsEl = document.getElementById('active-symbols');
        if (activeSymbolsEl) {
            activeSymbolsEl.textContent = formatNumber(data.scanner.active_symbols || 0);
        }
        
        const totalScansEl = document.getElementById('total-scans');
        if (totalScansEl) {
            totalScansEl.textContent = formatNumber(data.scanner.total_scans || 0);
        }
    }
}

// 更新连接状态
function updateConnectionsStatus(connections) {
    const redisStatus = document.getElementById('redis-status');
    const zmqStatus = document.getElementById('zmq-status');
    
    if (redisStatus && connections.redis !== undefined) {
        redisStatus.textContent = connections.redis ? '已连接' : '断开';
        redisStatus.className = `badge ${connections.redis ? 'bg-success' : 'bg-danger'}`;
    }
    
    if (zmqStatus && connections.zmq !== undefined) {
        zmqStatus.textContent = connections.zmq ? '已连接' : '断开';
        zmqStatus.className = `badge ${connections.zmq ? 'bg-success' : 'bg-danger'}`;
    }
}

// 更新性能指标
function updatePerformanceMetrics(data) {
    if (performanceChart && data.metrics) {
        const now = new Date().toLocaleTimeString();
        
        // 添加新数据点
        performanceChart.data.labels.push(now);
        performanceChart.data.datasets[0].data.push(data.metrics.cpu_usage || 0);
        performanceChart.data.datasets[1].data.push(data.metrics.memory_usage || 0);
        performanceChart.data.datasets[2].data.push(data.metrics.network_latency || 0);
        
        // 保持最近30个数据点
        if (performanceChart.data.labels.length > 30) {
            performanceChart.data.labels.shift();
            performanceChart.data.datasets.forEach(dataset => dataset.data.shift());
        }
        
        performanceChart.update('none');
    }
    
    // 更新性能指标数值显示
    if (data.metrics) {
        updateMetricValue('cpu-usage', data.metrics.cpu_usage, '%');
        updateMetricValue('memory-usage', data.metrics.memory_usage, '%');
        updateMetricValue('network-latency', data.metrics.network_latency, 'ms');
        updateMetricValue('scan-speed', data.metrics.scan_speed, '/s');
        updateMetricValue('queue-size', data.metrics.queue_size, '');
    }
}

// 更新指标数值显示
function updateMetricValue(elementId, value, unit) {
    const element = document.getElementById(elementId);
    if (element && value !== undefined) {
        element.textContent = formatNumber(value) + unit;
        
        // 添加数值变化动画
        element.classList.add('metric-updated');
        setTimeout(() => element.classList.remove('metric-updated'), 500);
    }
}

// 更新性能指标（兼容原有函数）
function updateMetrics(metrics) {
    document.getElementById('success-rate').textContent = 
        (metrics.success_rate || 0).toFixed(1) + '%';
    
    // 更新性能图表
    if (performanceChart && metrics.cpu_usage) {
        performanceChart.data.datasets[0].data = [
            metrics.cpu_usage,
            100 - metrics.cpu_usage
        ];
        performanceChart.update();
    }
}

// 更新最近结果
function updateRecentResults(data) {
    const resultsContainer = document.getElementById('recent-results');
    if (resultsContainer && data.results) {
        resultsContainer.innerHTML = '';
        
        data.results.slice(0, 8).forEach(result => {
            const resultElement = document.createElement('div');
            resultElement.className = 'result-item p-3 mb-2 border rounded';
            resultElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <strong class="me-2">${result.symbol}</strong>
                            <span class="badge bg-${getScoreBadgeClass(result.score)} me-2">${result.score.toFixed(2)}</span>
                            ${result.change_percent ? `<span class="badge ${result.change_percent >= 0 ? 'bg-success' : 'bg-danger'}">${result.change_percent >= 0 ? '+' : ''}${result.change_percent.toFixed(2)}%</span>` : ''}
                        </div>
                        <small class="text-muted">${result.rule_name}</small>
                        ${result.description ? `<div class="small text-secondary mt-1">${result.description}</div>` : ''}
                    </div>
                    <div class="text-end">
                        <div class="small text-muted">${formatTime(new Date(result.timestamp))}</div>
                        ${result.price ? `<div class="small">$${result.price.toFixed(4)}</div>` : ''}
                    </div>
                </div>
            `;
            
            // 添加点击事件
            resultElement.style.cursor = 'pointer';
            resultElement.addEventListener('click', () => {
                showResultDetails(result);
            });
            
            resultsContainer.appendChild(resultElement);
        });
        
        // 如果没有结果，显示提示信息
        if (data.results.length === 0) {
            resultsContainer.innerHTML = '<div class="text-center text-muted py-4">暂无扫描结果</div>';
        }
    }
}

// 显示结果详情
function showResultDetails(result) {
    const modal = new bootstrap.Modal(document.getElementById('resultDetailModal') || createResultDetailModal());
    
    // 填充模态框内容
    document.getElementById('modal-symbol').textContent = result.symbol;
    document.getElementById('modal-score').textContent = result.score.toFixed(2);
    document.getElementById('modal-rule').textContent = result.rule_name;
    document.getElementById('modal-timestamp').textContent = formatTime(new Date(result.timestamp));
    
    if (result.description) {
        document.getElementById('modal-description').textContent = result.description;
    }
    
    if (result.price) {
        document.getElementById('modal-price').textContent = '$' + result.price.toFixed(4);
    }
    
    modal.show();
}

// 创建结果详情模态框
function createResultDetailModal() {
    const modalHtml = `
        <div class="modal fade" id="resultDetailModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">扫描结果详情</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-sm-3"><strong>交易对:</strong></div>
                            <div class="col-sm-9" id="modal-symbol"></div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-sm-3"><strong>分数:</strong></div>
                            <div class="col-sm-9" id="modal-score"></div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-sm-3"><strong>规则:</strong></div>
                            <div class="col-sm-9" id="modal-rule"></div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-sm-3"><strong>时间:</strong></div>
                            <div class="col-sm-9" id="modal-timestamp"></div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-sm-3"><strong>价格:</strong></div>
                            <div class="col-sm-9" id="modal-price"></div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-sm-3"><strong>描述:</strong></div>
                            <div class="col-sm-9" id="modal-description"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" onclick="addToWatchlist()">添加到监控</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    return document.getElementById('resultDetailModal');
}

// 更新引擎状态
function updateEnginesStatus(engines) {
    const container = document.getElementById('engines-status');
    
    if (!engines) {
        container.innerHTML = '<div class="text-muted">引擎状态不可用</div>';
        return;
    }
    
    container.innerHTML = Object.entries(engines).map(([name, engine]) => {
        const statusClass = engine.enabled ? 'success' : 'secondary';
        const statusText = engine.enabled ? '启用' : '禁用';
        const displayName = {
            'three_high': '三高规则',
            'black_horse': '黑马检测',
            'potential_finder': '潜力挖掘'
        }[name] || name;
        
        return `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span>${displayName}</span>
                <span class="badge bg-${statusClass}">${statusText}</span>
            </div>
        `;
    }).join('');
}

// 更新系统信息
function updateSystemInfo(status) {
    const container = document.getElementById('system-info');
    
    const lastScan = status.scanner?.last_scan ? 
        formatTime(status.scanner.last_scan) : '未知';
    
    const redisStatus = status.connections?.redis ? '已连接' : '断开';
    const zmqStatus = status.connections?.zmq ? '已连接' : '断开';
    
    container.innerHTML = `
        <div class="mb-2">
            <small class="text-muted">最后扫描时间</small><br>
            <strong>${lastScan}</strong>
        </div>
        <div class="mb-2">
            <small class="text-muted">Redis连接</small><br>
            <span class="badge bg-${status.connections?.redis ? 'success' : 'danger'}">${redisStatus}</span>
        </div>
        <div class="mb-2">
            <small class="text-muted">ZMQ连接</small><br>
            <span class="badge bg-${status.connections?.zmq ? 'success' : 'danger'}">${zmqStatus}</span>
        </div>
        <div>
            <small class="text-muted">更新时间</small><br>
            <strong>${formatTime(status.timestamp)}</strong>
        </div>
    `;
}

// 辅助函数
function formatNumber(num) {
    if (typeof num !== 'number') return '0';
    
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toLocaleString();
}

function formatTime(date) {
    if (!date || !(date instanceof Date)) {
        return '--:--:--';
    }
    
    return date.toLocaleTimeString('zh-CN', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

function getScoreBadgeClass(score) {
    if (score >= 80) return 'success';
    if (score >= 60) return 'warning';
    if (score >= 40) return 'info';
    return 'secondary';
}

// 添加到监控列表
function addToWatchlist() {
    const symbol = document.getElementById('modal-symbol').textContent;
    if (symbol) {
        fetch('/api/watchlist', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ symbol: symbol })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert({
                    type: 'success',
                    title: '成功',
                    message: `${symbol} 已添加到监控列表`
                });
            } else {
                showAlert({
                    type: 'error',
                    title: '错误',
                    message: data.message || '添加失败'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert({
                type: 'error',
                title: '错误',
                message: '网络错误，请稍后重试'
            });
        });
        
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('resultDetailModal'));
        if (modal) modal.hide();
    }
}
</script>
{% endblock %}