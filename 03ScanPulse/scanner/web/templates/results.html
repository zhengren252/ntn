{% extends "base.html" %}

{% block title %}扫描结果 - ScanPulse{% endblock %}

{% block page_title %}扫描结果展示{% endblock %}

{% block content %}
<div class="row mb-4">
    <!-- 筛选器 -->
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-2">
                        <label class="form-label">扫描类型</label>
                        <select class="form-select" id="filterType">
                            <option value="">全部类型</option>
                            <option value="three_high">三高规则</option>
                            <option value="black_horse">黑马检测</option>
                            <option value="potential_finder">潜力挖掘</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">时间范围</label>
                        <select class="form-select" id="filterTime">
                            <option value="1h">最近1小时</option>
                            <option value="6h">最近6小时</option>
                            <option value="24h" selected>最近24小时</option>
                            <option value="7d">最近7天</option>
                            <option value="30d">最近30天</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">最小分数</label>
                        <input type="number" class="form-control" id="filterScore" placeholder="0.0" step="0.1" min="0" max="1">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">交易对</label>
                        <input type="text" class="form-control" id="filterSymbol" placeholder="如: BTCUSDT">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">排序方式</label>
                        <select class="form-select" id="sortBy">
                            <option value="timestamp">时间</option>
                            <option value="score" selected>分数</option>
                            <option value="symbol">交易对</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button class="btn btn-primary" onclick="applyFilters()">
                                <i class="fas fa-search"></i> 筛选
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 结果列表 -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold"><i class="fas fa-list"></i> 扫描结果</h6>
                <div>
                    <button class="btn btn-sm btn-outline-success" onclick="exportResults()">
                        <i class="fas fa-download"></i> 导出
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadResults()">
                        <i class="fas fa-sync-alt"></i> 刷新
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="results-list">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
                
                <!-- 分页 -->
                <nav class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- 分页按钮将通过JavaScript生成 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    
    <!-- 统计信息 -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold"><i class="fas fa-chart-bar"></i> 结果统计</h6>
            </div>
            <div class="card-body">
                <canvas id="results-chart" width="400" height="300"></canvas>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold"><i class="fas fa-trophy"></i> 热门交易对</h6>
            </div>
            <div class="card-body">
                <div id="top-symbols">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold"><i class="fas fa-info-circle"></i> 统计摘要</h6>
            </div>
            <div class="card-body">
                <div id="stats-summary">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 结果详情模态框 -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalTitle">扫描结果详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="result-detail">
                    <!-- 详情内容将通过JavaScript填充 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="addToWatchlist()">添加到监控</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let resultsChart;
let currentPage = 1;
let totalPages = 1;
let currentResult = null;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadResults();
    loadStatistics();
    initializeAdvancedFilters();
    initializeSearch();
    initializeExport();
});

// 初始化图表
function initializeCharts() {
    const ctx = document.getElementById('results-chart').getContext('2d');
    resultsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['三高规则', '黑马检测', '潜力挖掘'],
            datasets: [{
                label: '结果数量',
                data: [0, 0, 0],
                backgroundColor: ['#667eea', '#f093fb', '#4facfe'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// 加载扫描结果
function loadResults(page = 1) {
    currentPage = page;
    showLoading('results-list');
    
    const params = new URLSearchParams({
        page: page,
        limit: 20,
        ...getFilters()
    });
    
    fetch(`/api/results?${params}`)
        .then(response => response.json())
        .then(data => {
            updateResultsList(data.results || []);
            updatePagination(data.pagination || {});
        })
        .catch(error => {
            console.error('Error loading results:', error);
            showError('results-list', '加载结果失败');
        });
}

// 获取筛选条件
function getFilters() {
    const filters = {};
    
    const type = document.getElementById('filterType').value;
    if (type) filters.type = type;
    
    const time = document.getElementById('filterTime').value;
    if (time) filters.time_range = time;
    
    const score = document.getElementById('filterScore').value;
    if (score) filters.min_score = parseFloat(score);
    
    const symbol = document.getElementById('filterSymbol').value;
    if (symbol) filters.symbol = symbol.toUpperCase();
    
    const sortBy = document.getElementById('sortBy').value;
    if (sortBy) filters.sort_by = sortBy;
    
    return filters;
}

// 应用筛选条件
function applyFilters() {
    loadResults(1);
}

// 更新结果列表
function updateResultsList(results) {
    const container = document.getElementById('results-list');
    
    if (results.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">暂无扫描结果</div>';
        return;
    }
    
    const typeNames = {
        'three_high': '三高规则',
        'black_horse': '黑马检测',
        'potential_finder': '潜力挖掘'
    };
    
    const typeColors = {
        'three_high': 'primary',
        'black_horse': 'success',
        'potential_finder': 'info'
    };
    
    container.innerHTML = results.map(result => {
        const typeName = typeNames[result.type] || result.type;
        const typeColor = typeColors[result.type] || 'secondary';
        const scoreClass = result.score >= 0.8 ? 'success' : result.score >= 0.6 ? 'warning' : 'danger';
        
        return `
            <div class="card mb-3 result-card" onclick="showResultDetail('${result.id}')" style="cursor: pointer;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <h6 class="mb-0 me-3">
                                    <i class="fas fa-coins me-2"></i>
                                    <strong>${result.symbol}</strong>
                                </h6>
                                <span class="badge bg-${typeColor}">${typeName}</span>
                                <span class="badge bg-${scoreClass} ms-2">${(result.score * 100).toFixed(1)}%</span>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3">
                                    <small class="text-muted">扫描时间:</small><br>
                                    <strong>${formatTime(result.timestamp)}</strong>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">价格:</small><br>
                                    <strong>${result.price ? '$' + formatNumber(result.price) : 'N/A'}</strong>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">24h变化:</small><br>
                                    <strong class="${result.change_24h >= 0 ? 'text-success' : 'text-danger'}">
                                        ${result.change_24h ? (result.change_24h > 0 ? '+' : '') + result.change_24h.toFixed(2) + '%' : 'N/A'}
                                    </strong>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">成交量:</small><br>
                                    <strong>${result.volume ? formatNumber(result.volume) : 'N/A'}</strong>
                                </div>
                            </div>
                            
                            ${result.signals && result.signals.length > 0 ? `
                                <div class="mt-2">
                                    <small class="text-muted">信号:</small>
                                    <div class="mt-1">
                                        ${result.signals.map(signal => 
                                            `<span class="badge bg-light text-dark me-1">${signal}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="text-end">
                            <div class="score-circle bg-${scoreClass}">
                                ${(result.score * 100).toFixed(0)}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// 更新分页
function updatePagination(pagination) {
    const container = document.getElementById('pagination');
    totalPages = pagination.total_pages || 1;
    currentPage = pagination.current_page || 1;
    
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // 上一页
    paginationHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadResults(${currentPage - 1})">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `;
    
    // 页码
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        paginationHTML += '<li class="page-item"><a class="page-link" href="#" onclick="loadResults(1)">1</a></li>';
        if (startPage > 2) {
            paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadResults(${i})">${i}</a>
            </li>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadResults(${totalPages})">${totalPages}</a></li>`;
    }
    
    // 下一页
    paginationHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadResults(${currentPage + 1})">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `;
    
    container.innerHTML = paginationHTML;
}

// 加载统计信息
function loadStatistics() {
    Promise.all([
        fetch('/api/results/stats').then(r => r.json()),
        fetch('/api/results/top-symbols').then(r => r.json())
    ]).then(([stats, topSymbols]) => {
        updateResultsChart(stats.by_type || {});
        updateTopSymbols(topSymbols.symbols || []);
        updateStatsSummary(stats);
    }).catch(error => {
        console.error('Error loading statistics:', error);
    });
}

// 更新结果统计图表
function updateResultsChart(byType) {
    if (resultsChart) {
        resultsChart.data.datasets[0].data = [
            byType.three_high || 0,
            byType.black_horse || 0,
            byType.potential_finder || 0
        ];
        resultsChart.update();
    }
}

// 更新热门交易对
function updateTopSymbols(symbols) {
    const container = document.getElementById('top-symbols');
    
    if (symbols.length === 0) {
        container.innerHTML = '<div class="text-muted">暂无数据</div>';
        return;
    }
    
    container.innerHTML = symbols.slice(0, 10).map((symbol, index) => `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <span class="badge bg-primary me-2">${index + 1}</span>
                <strong>${symbol.symbol}</strong>
            </div>
            <span class="text-muted">${symbol.count}次</span>
        </div>
    `).join('');
}

// 更新统计摘要
function updateStatsSummary(stats) {
    const container = document.getElementById('stats-summary');
    
    container.innerHTML = `
        <div class="mb-3">
            <div class="d-flex justify-content-between">
                <span>总结果数:</span>
                <strong>${formatNumber(stats.total || 0)}</strong>
            </div>
        </div>
        <div class="mb-3">
            <div class="d-flex justify-content-between">
                <span>今日新增:</span>
                <strong>${formatNumber(stats.today || 0)}</strong>
            </div>
        </div>
        <div class="mb-3">
            <div class="d-flex justify-content-between">
                <span>平均分数:</span>
                <strong>${(stats.avg_score || 0).toFixed(2)}</strong>
            </div>
        </div>
        <div class="mb-3">
            <div class="d-flex justify-content-between">
                <span>高分结果:</span>
                <strong>${formatNumber(stats.high_score || 0)}</strong>
            </div>
        </div>
        <div>
            <div class="d-flex justify-content-between">
                <span>活跃交易对:</span>
                <strong>${formatNumber(stats.active_symbols || 0)}</strong>
            </div>
        </div>
    `;
}

// 显示结果详情
function showResultDetail(resultId) {
    fetch(`/api/results/${resultId}`)
        .then(response => response.json())
        .then(result => {
            currentResult = result;
            updateResultDetail(result);
            new bootstrap.Modal(document.getElementById('resultModal')).show();
        })
        .catch(error => {
            console.error('Error loading result detail:', error);
            alert('加载详情失败');
        });
}

// 更新结果详情
function updateResultDetail(result) {
    const container = document.getElementById('result-detail');
    
    const typeNames = {
        'three_high': '三高规则',
        'black_horse': '黑马检测',
        'potential_finder': '潜力挖掘'
    };
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>基本信息</h6>
                <table class="table table-sm">
                    <tr><td>交易对:</td><td><strong>${result.symbol}</strong></td></tr>
                    <tr><td>扫描类型:</td><td>${typeNames[result.type] || result.type}</td></tr>
                    <tr><td>扫描分数:</td><td><strong>${(result.score * 100).toFixed(2)}%</strong></td></tr>
                    <tr><td>扫描时间:</td><td>${formatTime(result.timestamp)}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>市场数据</h6>
                <table class="table table-sm">
                    <tr><td>当前价格:</td><td><strong>${result.price ? '$' + formatNumber(result.price) : 'N/A'}</strong></td></tr>
                    <tr><td>24h变化:</td><td class="${result.change_24h >= 0 ? 'text-success' : 'text-danger'}">
                        <strong>${result.change_24h ? (result.change_24h > 0 ? '+' : '') + result.change_24h.toFixed(2) + '%' : 'N/A'}</strong>
                    </td></tr>
                    <tr><td>24h成交量:</td><td>${result.volume ? formatNumber(result.volume) : 'N/A'}</td></tr>
                    <tr><td>市值排名:</td><td>${result.market_cap_rank || 'N/A'}</td></tr>
                </table>
            </div>
        </div>
        
        ${result.signals && result.signals.length > 0 ? `
            <div class="mt-4">
                <h6>检测信号</h6>
                <div>
                    ${result.signals.map(signal => 
                        `<span class="badge bg-primary me-2 mb-2">${signal}</span>`
                    ).join('')}
                </div>
            </div>
        ` : ''}
        
        ${result.indicators ? `
            <div class="mt-4">
                <h6>技术指标</h6>
                <div class="row">
                    ${Object.entries(result.indicators).map(([key, value]) => `
                        <div class="col-md-4 mb-2">
                            <small class="text-muted">${key.toUpperCase()}:</small><br>
                            <strong>${typeof value === 'number' ? value.toFixed(4) : value}</strong>
                        </div>
                    `).join('')}
                </div>
            </div>
        ` : ''}
        
        ${result.metadata ? `
            <div class="mt-4">
                <h6>附加信息</h6>
                <pre class="bg-light p-3"><code>${JSON.stringify(result.metadata, null, 2)}</code></pre>
            </div>
        ` : ''}
    `;
}

// 添加到监控列表
function addToWatchlist() {
    if (!currentResult) return;
    
    fetch('/api/watchlist', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            symbol: currentResult.symbol,
            type: currentResult.type,
            score: currentResult.score
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('已添加到监控列表');
            bootstrap.Modal.getInstance(document.getElementById('resultModal')).hide();
        } else {
            alert('添加失败: ' + (result.error || '未知错误'));
        }
    })
    .catch(error => {
        console.error('Error adding to watchlist:', error);
        alert('添加失败');
    });
}

// 导出结果
function exportResults() {
    const filters = getFilters();
    const format = document.getElementById('export-format')?.value || 'csv';
    const selectedResults = getSelectedResults();
    
    // 显示导出进度
    showExportProgress();
    
    fetch('/api/results/export', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            filters: filters,
            format: format,
            selected_ids: selectedResults
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('导出失败');
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `scan_results_${new Date().toISOString().split('T')[0]}.${format}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        hideExportProgress();
        showAlert('导出成功', 'success');
    })
    .catch(error => {
        console.error('Export error:', error);
        hideExportProgress();
        showAlert('导出失败', 'danger');
    });
}

// 获取选中的结果
function getSelectedResults() {
    const checkboxes = document.querySelectorAll('.result-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

// 显示导出进度
function showExportProgress() {
    const btn = document.querySelector('[onclick="exportResults()"]');
    if (btn) {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 导出中...';
        btn.disabled = true;
    }
}

// 隐藏导出进度
function hideExportProgress() {
    const btn = document.querySelector('[onclick="exportResults()"]');
    if (btn) {
        btn.innerHTML = '<i class="fas fa-download"></i> 导出';
        btn.disabled = false;
    }
}

// 初始化高级过滤器
function initializeAdvancedFilters() {
    // 添加自定义日期范围选择
    const timeRangeSelect = document.getElementById('time-range');
    if (timeRangeSelect) {
        timeRangeSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                showCustomDateRange();
            } else {
                hideCustomDateRange();
            }
        });
    }

    // 添加分数范围滑块
    initializeScoreRange();
    
    // 添加交易对多选
    initializeSymbolMultiSelect();
}

// 显示自定义日期范围
function showCustomDateRange() {
    let customRange = document.getElementById('custom-date-range');
    if (!customRange) {
        customRange = document.createElement('div');
        customRange.id = 'custom-date-range';
        customRange.className = 'mt-2';
        customRange.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">开始日期</label>
                    <input type="datetime-local" class="form-control" id="start-date">
                </div>
                <div class="col-md-6">
                    <label class="form-label">结束日期</label>
                    <input type="datetime-local" class="form-control" id="end-date">
                </div>
            </div>
        `;
        document.getElementById('time-range').parentNode.appendChild(customRange);
    }
    customRange.style.display = 'block';
}

// 隐藏自定义日期范围
function hideCustomDateRange() {
    const customRange = document.getElementById('custom-date-range');
    if (customRange) {
        customRange.style.display = 'none';
    }
}

// 初始化分数范围滑块
function initializeScoreRange() {
    const minScoreInput = document.getElementById('min-score');
    if (minScoreInput && !document.getElementById('score-range-slider')) {
        const sliderContainer = document.createElement('div');
        sliderContainer.innerHTML = `
            <div class="mt-2">
                <label class="form-label">分数范围: <span id="score-range-display">0 - 100</span></label>
                <div id="score-range-slider" class="range-slider">
                    <input type="range" id="min-score-slider" min="0" max="100" value="0" class="form-range">
                    <input type="range" id="max-score-slider" min="0" max="100" value="100" class="form-range">
                </div>
            </div>
        `;
        minScoreInput.parentNode.appendChild(sliderContainer);
        
        // 绑定滑块事件
        const minSlider = document.getElementById('min-score-slider');
        const maxSlider = document.getElementById('max-score-slider');
        const display = document.getElementById('score-range-display');
        
        function updateScoreRange() {
            const min = parseInt(minSlider.value);
            const max = parseInt(maxSlider.value);
            
            if (min > max) {
                minSlider.value = max;
            }
            if (max < min) {
                maxSlider.value = min;
            }
            
            display.textContent = `${minSlider.value} - ${maxSlider.value}`;
            minScoreInput.value = minSlider.value;
        }
        
        minSlider.addEventListener('input', updateScoreRange);
        maxSlider.addEventListener('input', updateScoreRange);
    }
}

// 初始化交易对多选
function initializeSymbolMultiSelect() {
    const symbolSelect = document.getElementById('symbol-filter');
    if (symbolSelect && !symbolSelect.dataset.multiselect) {
        symbolSelect.dataset.multiselect = 'true';
        symbolSelect.multiple = true;
        symbolSelect.size = 4;
        
        // 加载可用的交易对
        loadAvailableSymbols();
    }
}

// 加载可用的交易对
function loadAvailableSymbols() {
    fetch('/api/symbols')
    .then(response => response.json())
    .then(data => {
        const symbolSelect = document.getElementById('symbol-filter');
        symbolSelect.innerHTML = '<option value="">所有交易对</option>';
        
        data.symbols.forEach(symbol => {
            const option = document.createElement('option');
            option.value = symbol;
            option.textContent = symbol;
            symbolSelect.appendChild(option);
        });
    })
    .catch(error => {
        console.error('Error loading symbols:', error);
    });
}

// 初始化搜索功能
function initializeSearch() {
    const searchInput = document.getElementById('search-input');
    if (!searchInput) {
        // 创建搜索输入框
        const searchContainer = document.createElement('div');
        searchContainer.className = 'col-md-3';
        searchContainer.innerHTML = `
            <label class="form-label">搜索</label>
            <div class="input-group">
                <input type="text" class="form-control" id="search-input" placeholder="搜索交易对、描述...">
                <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        // 插入到过滤器行
        const filterRow = document.querySelector('.row');
        if (filterRow) {
            filterRow.appendChild(searchContainer);
        }
    }
    
    // 绑定搜索事件
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        let searchTimer;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                applyFilters();
            }, 300); // 300ms 延迟搜索
        });
    }
}

// 清除搜索
function clearSearch() {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.value = '';
        applyFilters();
    }
}

// 初始化导出功能
function initializeExport() {
    // 添加批量选择功能
    addBatchSelection();
    
    // 添加导出选项
    addExportOptions();
}

// 添加批量选择功能
function addBatchSelection() {
    const resultsHeader = document.querySelector('.card-header h5');
    if (resultsHeader && !document.getElementById('select-all-checkbox')) {
        const selectAllContainer = document.createElement('div');
        selectAllContainer.className = 'form-check d-inline-block me-3';
        selectAllContainer.innerHTML = `
            <input class="form-check-input" type="checkbox" id="select-all-checkbox">
            <label class="form-check-label" for="select-all-checkbox">
                全选
            </label>
        `;
        
        resultsHeader.parentNode.insertBefore(selectAllContainer, resultsHeader);
        
        // 绑定全选事件
        document.getElementById('select-all-checkbox').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.result-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateSelectionCount();
        });
    }
}

// 添加导出选项
function addExportOptions() {
    const exportBtn = document.querySelector('[onclick="exportResults()"]');
    if (exportBtn && !document.getElementById('export-options')) {
        const exportContainer = document.createElement('div');
        exportContainer.id = 'export-options';
        exportContainer.className = 'btn-group';
        exportContainer.innerHTML = `
            <select class="form-select" id="export-format" style="width: auto;">
                <option value="csv">CSV</option>
                <option value="xlsx">Excel</option>
                <option value="json">JSON</option>
                <option value="pdf">PDF</option>
            </select>
        `;
        
        exportBtn.parentNode.insertBefore(exportContainer, exportBtn);
    }
}

// 更新选择计数
function updateSelectionCount() {
    const selectedCount = document.querySelectorAll('.result-checkbox:checked').length;
    const totalCount = document.querySelectorAll('.result-checkbox').length;
    
    let countDisplay = document.getElementById('selection-count');
    if (!countDisplay) {
        countDisplay = document.createElement('span');
        countDisplay.id = 'selection-count';
        countDisplay.className = 'text-muted ms-2';
        document.querySelector('.card-header h5').appendChild(countDisplay);
    }
    
    if (selectedCount > 0) {
        countDisplay.textContent = `(已选择 ${selectedCount}/${totalCount})`;
    } else {
        countDisplay.textContent = '';
    }
}

// 显示提示信息
function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container') || document.body;
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    alertContainer.appendChild(alert);
    
    // 3秒后自动消失
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 3000);
}
</script>

<style>
.result-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
    transition: all 0.3s ease;
}

.score-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
}

.page-link {
    color: #667eea;
}

.page-item.active .page-link {
    background-color: #667eea;
    border-color: #667eea;
}
</style>
{% endblock %}