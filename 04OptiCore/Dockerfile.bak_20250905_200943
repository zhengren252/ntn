# NeuroTrade Nexus (NTN) - ç­–ç•¥ä¼˜åŒ–æ¨¡ç»„ Docker é…ç½®
# Strategy Optimization Module Dockerfile
<<<<<<< HEAD
# é‡‡ç”¨å¤šé˜¶æ®µæ„å»ºä»¥å‡å°æœ€ç»ˆé•œåƒä½“ç§¯
=======
# é‡‡ç”¨å¤šé˜¶æ®µæ„å»ºä»¥å‡å°æœ€ç»ˆé•œåƒä½“ç§?
>>>>>>> 4d5ab11 (chore: init repo (private) [skip ci])

# =================================================================
# æ„å»ºé˜¶æ®µ (Builder Stage)
# =================================================================
FROM python:3.11-slim AS builder

# è®¾ç½®æ„å»ºé˜¶æ®µç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    DEBIAN_FRONTEND=noninteractive

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources 2>/dev/null || sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list && apt-get update && apt-get install -y --fix-missing -o Acquire::Retries=3 -o Acquire::http::Timeout=30 \
    build-essential \
    gcc \
    g++ \
    make \
    cmake \
    pkg-config \
    libffi-dev \
    libssl-dev \
    libzmq3-dev \
    libhdf5-dev \
    libatlas3-base \
    gfortran \
    libblas-dev \
    liblapack-dev \
    libfreetype6-dev \
    libpng-dev \
    libjpeg-dev \
    curl \
    wget \
    git \
    && rm -rf /var/lib/apt/lists/*

<<<<<<< HEAD
# å®‰è£…TA-Lib Cåº“ï¼ˆé‡‘èæŠ€æœ¯åˆ†æåº“ï¼‰
=======
# å®‰è£…TA-Lib Cåº“ï¼ˆé‡‘èæŠ€æœ¯åˆ†æåº“ï¼?
>>>>>>> 4d5ab11 (chore: init repo (private) [skip ci])
RUN cd /tmp && \
    wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz && \
    tar -xzf ta-lib-0.4.0-src.tar.gz && \
    cd ta-lib/ && \
    ./configure --prefix=/usr && \
    make && \
    make install && \
    cd / && \
    rm -rf /tmp/ta-lib*

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…Pythonä¾èµ–
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# å¤åˆ¶requirementsæ–‡ä»¶
COPY requirements.txt .

# å‡çº§pipå¹¶å®‰è£…Pythonä¾èµ–
RUN pip install --upgrade pip setuptools wheel && \
    pip install --no-cache-dir numpy==1.25.2 pandas==2.1.4 scipy==1.11.4 && \
    pip install --no-cache-dir -r requirements.txt

# =================================================================
# ç”Ÿäº§é˜¶æ®µ (Production Stage)
# =================================================================
FROM python:3.11-slim AS production

# è®¾ç½®ç»´æŠ¤è€…ä¿¡æ¯å’Œæ ‡ç­¾
LABEL maintainer="NeuroTrade Nexus Team" \
      description="Strategy Optimization Module for NeuroTrade Nexus" \
      version="1.0.0" \
      component="opticore"

# è®¾ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    NTN_ENVIRONMENT=production \
    PYTHONPATH=/app \
    PATH="/opt/venv/bin:$PATH"

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

<<<<<<< HEAD
# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
=======
# å®‰è£…è¿è¡Œæ—¶ä¾èµ?
>>>>>>> 4d5ab11 (chore: init repo (private) [skip ci])
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources 2>/dev/null || sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list && apt-get update && apt-get install -y --no-install-recommends \
    libzmq5 \
    libhdf5-310 \
    libatlas3-base \
    libfreetype6 \
    libpng16-16 \
    libjpeg62-turbo \
    curl \
    && rm -rf /var/lib/apt/lists/*

<<<<<<< HEAD
# ä»æ„å»ºé˜¶æ®µå¤åˆ¶è™šæ‹Ÿç¯å¢ƒå’ŒTA-Libåº“
=======
# ä»æ„å»ºé˜¶æ®µå¤åˆ¶è™šæ‹Ÿç¯å¢ƒå’ŒTA-Libåº?
>>>>>>> 4d5ab11 (chore: init repo (private) [skip ci])
COPY --from=builder /opt/venv /opt/venv
COPY --from=builder /usr/lib/libta_lib.* /usr/lib/
COPY --from=builder /usr/include/ta-lib/ /usr/include/ta-lib/

# åˆ›å»ºérootç”¨æˆ·
RUN groupadd -r ntn && useradd -r -g ntn -d /app -s /bin/bash ntn

<<<<<<< HEAD
# åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
=======
# åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ?
>>>>>>> 4d5ab11 (chore: init repo (private) [skip ci])
RUN mkdir -p /app/logs \
             /app/data \
             /app/cache \
             /app/temp \
             /app/config \
             /app/tests/logs \
             /app/supabase/migrations && \
    chown -R ntn:ntn /app

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY --chown=ntn:ntn . .

# è®¾ç½®æƒé™
RUN chmod +x /app/scripts/*.sh 2>/dev/null || true && \
    chmod 755 /app

<<<<<<< HEAD
# åˆ›å»ºå¥åº·æ£€æŸ¥è„šæœ¬
=======
# åˆ›å»ºå¥åº·æ£€æŸ¥è„šæœ?
>>>>>>> 4d5ab11 (chore: init repo (private) [skip ci])
RUN echo '#!/bin/bash\n\
curl -f http://localhost:8000/health || exit 1' > /app/healthcheck.sh && \
    chmod +x /app/healthcheck.sh && \
    chown ntn:ntn /app/healthcheck.sh

# æš´éœ²ç«¯å£
EXPOSE 8000 5555 5556

<<<<<<< HEAD
# å¥åº·æ£€æŸ¥
=======
# å¥åº·æ£€æŸ?
>>>>>>> 4d5ab11 (chore: init repo (private) [skip ci])
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD /app/healthcheck.sh

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER ntn

# è®¾ç½®å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "api.app:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "4"]

# =================================================================
<<<<<<< HEAD
# Dockeræ„å»ºå’Œè¿è¡Œè¯´æ˜
=======
# Dockeræ„å»ºå’Œè¿è¡Œè¯´æ˜?
>>>>>>> 4d5ab11 (chore: init repo (private) [skip ci])
# =================================================================
# Build: docker build --target production -t ntn-opticore:latest .
# Run: docker run -d -p 8000:8000 -p 5555:5555 -p 5556:5556 \
#      -e NTN_ENVIRONMENT=production \
#      -e DATABASE_PATH=/app/data/opticore.db \
#      -e REDIS_HOST=redis \
#      -e ZMQ_SUBSCRIBER_PORT=5555 \
#      -e ZMQ_PUBLISHER_PORT=5556 \
#      -v /host/data:/app/data \
#      -v /host/logs:/app/logs \
#      --name ntn-opticore \
<<<<<<< HEAD
#      ntn-opticore:latest
=======
#      ntn-opticore:latest
>>>>>>> 4d5ab11 (chore: init repo (private) [skip ci])
